name: Update GitHub Productivity Tracker
on:
  schedule:
    - cron: "0 6 * * *" # daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get month date range
        id: dates
        run: |
          FIRST_DAY=$(date -u +%Y-%m-01)
          NEXT_MONTH_FIRST=$(date -u -d "$(date -u +%Y-%m-01) +1 month" +%Y-%m-01)
          LAST_DAY=$(date -u -d "$NEXT_MONTH_FIRST -1 day" +%Y-%m-%d)
          echo "first=$FIRST_DAY" >> $GITHUB_OUTPUT
          echo "last=$LAST_DAY" >> $GITHUB_OUTPUT

      - name: Query GitHub GraphQL for contributions in month
        id: contributions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          FIRST="${{ steps.dates.outputs.first }}"
          LAST="${{ steps.dates.outputs.last }}"

          # Build JSON payload safely using jq
          PAYLOAD=$(jq -nc --arg login "$OWNER" --arg from "${FIRST}T00:00:00Z" --arg to "${LAST}T23:59:59Z" \
            '{query:"query($login: String!, $from: DateTime!, $to: DateTime!){ user(login: $login){ contributionsCollection(from: $from, to: $to){ contributionCalendar{ totalContributions } } } }", variables:{login:$login, from:$from, to:$to}}')

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            https://api.github.com/graphql)

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      - name: Parse contributions count
        id: parse
        run: |
          printf '%s' "${{ steps.contributions.outputs.response }}" | jq -r '.data.user.contributionsCollection.contributionCalendar.totalContributions' > contrib_count.txt
          COUNT=$(cat contrib_count.txt)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Update README section (python)
        id: update_readme
        run: |
          python3 - <<'PY'
          import textwrap, sys
          script = textwrap.dedent("""\
          import re, sys, json, math
          from pathlib import Path

          p = Path("README.md")
          if not p.exists():
              print("README.md not found", file=sys.stderr)
              sys.exit(1)

          # Get count from environment variable or output
          count = int("${{ steps.parse.outputs.count }}")
          tiers = [
              {"name":"Inactive","max":9,"emoji":"ðŸª¶"},
              {"name":"Emerging Contributor","max":49,"emoji":"ðŸŒ±"},
              {"name":"Consistent Developer","max":99,"emoji":"âš™ï¸"},
              {"name":"Productive Developer","max":199,"emoji":"ðŸ’»"},
              {"name":"Highly Active Maintainer","max":399,"emoji":"ðŸš€"},
              {"name":"Power Contributor","max":10**9,"emoji":"ðŸ”¥"},
          ]

          tier = next(t for t in tiers if count <= t["max"])
          next_tier = tiers[tiers.index(tier)+1] if tiers.index(tier)+1 < len(tiers) else tier
          next_max = next_tier["max"]
          progress_pct = int(min(100, math.floor((count / next_max) * 100))) if next_max else 100
          blocks = int(round(progress_pct/5))
          bar = "â–ˆ"*blocks + "â–‘"*(20-blocks)

          new_section = f"""
          | **Tier** | **Contributions / Month** | **Status** |
          |-----------|---------------------------|-------------|
          | ðŸª¶ Tier 0 â€“ Inactive | 0â€“9 | â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0% |
          | ðŸŒ± Tier 1 â€“ Emerging Contributor | 10â€“49 | â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20% |
          | âš™ï¸ Tier 2 â€“ Consistent Developer | 50â€“99 | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40% |
          | ðŸ’» Tier 3 â€“ Productive Developer | 100â€“199 | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60% |
          | ðŸš€ Tier 4 â€“ Highly Active Maintainer | 200â€“399 | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 80% |
          | ðŸ”¥ Tier 5 â€“ Power Contributor | 400+ | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% ðŸ† |

          **Current Status:** {tier["emoji"]} *{tier["name"]}*  
          **Contributions this month:** `{count}`  
          **Next Goal:** {next_tier["emoji"]} *{next_tier["name"]}* ({next_max}+)  
          **Progress:** `{count} / {next_max}` â†’ {bar} {progress_pct}%
          """

          text = p.read_text(encoding="utf-8")
          new_text = re.sub(
              r"<!--START_SECTION:productivity-->[\\s\\S]*?<!--END_SECTION:productivity-->",
              f"<!--START_SECTION:productivity-->\\n{new_section}\\n<!--END_SECTION:productivity-->",
              text
          )
          p.write_text(new_text, encoding="utf-8")
          print("README updated")
          """)
          exec(script)
          PY

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update productivity tracker" || echo "No changes to commit"
          git push